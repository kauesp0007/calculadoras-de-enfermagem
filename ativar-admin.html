<!DOCTYPE html>
<html lang="pt-br">
<head>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="dns-prefetch" href="//googleads.g.doubleclick.net">
    <link rel="dns-prefetch" href="//pagead2.googlesyndication.com">
    <link rel="preconnect" href="https://www.googletagmanager.com">

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Admin - Calculadoras de Enfermagem</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            background-color: #f0f2f5;
            margin: 0;
            text-align: center;
        }
        .card {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            max-width: 90%;
            width: 400px;
        }
        h1 { color: #333; margin-bottom: 20px; font-size: 1.5rem; }
        .status {
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 6px;
            font-weight: bold;
        }
        .status.on { background-color: #d1fae5; color: #065f46; border: 1px solid #34d399; }
        .status.off { background-color: #fee2e2; color: #991b1b; border: 1px solid #f87171; }

        button {
            width: 100%;
            padding: 15px;
            margin: 5px 0;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            font-weight: bold;
            transition: opacity 0.2s;
        }
        button:active { opacity: 0.8; }
        .btn-ativar { background-color: #10b981; color: white; }
        .btn-desativar { background-color: #ef4444; color: white; }
        .footer { margin-top: 20px; font-size: 0.8rem; color: #666; }
    </style>
</head>
<body>

    <div class="card">
        <h1>Painel de Controle üõ°Ô∏è</h1>
        <p>Status atual do Modo Admin:</p>
        <div id="status-display" class="status off">Verificando...</div>

        <button onclick="ativar()" class="btn-ativar">ATIVAR MODO ADMIN (Bloquear Ads)</button>
        <button onclick="desativar()" class="btn-desativar">DESATIVAR (Voltar ao normal)</button>

        <div class="footer">
            <p>Ative isso em todos os seus dispositivos (PC e Celular) para n√£o gerar tr√°fego inv√°lido no AdSense.</p>
            <a href="/" style="color:#2563eb; text-decoration: none;">Ir para a Home</a>
        </div>
    </div>

    <!-- SCRIPT 1: L√ìGICA DOS BOT√ïES DO PAINEL -->
    <script>
        function checkStatus() {
            var status = localStorage.getItem('admin_mode');
            var display = document.getElementById('status-display');
            if (status === 'true') {
                display.innerText = 'ATIVADO (An√∫ncios Bloqueados)';
                display.className = 'status on';
            } else {
                display.innerText = 'DESATIVADO (An√∫ncios Vis√≠veis)';
                display.className = 'status off';
            }
        }

        function ativar() {
            localStorage.setItem('admin_mode', 'true');
            checkStatus();
            alert('Modo Admin ATIVADO!\n\nO script de analytics e adsense n√£o ser√° mais carregado neste navegador.');
            location.reload();
        }

        function desativar() {
            localStorage.setItem('admin_mode', 'false');
            checkStatus();
            alert('Modo Admin DESATIVADO!\n\nVoc√™ voltou a ser um visitante comum.');
            location.reload();
        }

        // Verifica o status ao abrir a p√°gina
        checkStatus();
    </script>

    <!-- SCRIPT 2: O SCRIPT DE RASTREAMENTO QUE QUEREMOS TESTAR/CONTROLAR -->
    <script>
    /* =========================================================
       MODO ADMIN + GOOGLE TAG + CONSENT + ADSENSE
       (VERS√ÉO OPT-OUT: Carrega an√∫ncios por padr√£o)
       ========================================================= */

    // üõ°Ô∏è MODO ADMIN ‚Äî bloqueia tudo
    if (localStorage.getItem('admin_mode') === 'true') {
      console.log('üöß Modo Admin: Analytics e AdSense N√ÉO foram carregados.');
    } else {

      // 0) VERIFICA√á√ÉO INICIAL (Novo)
      var savedConsent = localStorage.getItem("cookieConsent");
      var isRefused = (savedConsent === "refused");

      // Prote√ß√µes globais
      window.__metricsLoaded = window.__metricsLoaded || false;
      window.__adsenseLoaded = window.__adsenseLoaded || false;

      /* -----------------------------------------------------
          1) GOOGLE TAG (gtag.js)
          ----------------------------------------------------- */
      if (!window.__metricsLoaded) {
        window.__metricsLoaded = true;

        var scriptGA = document.createElement('script');
        scriptGA.async = true;
        // üí° MELHORIA: Carregar direto da origem do Analytics (G-...) em vez do Ads (AW-...)
        scriptGA.src = "https://www.googletagmanager.com/gtag/js?id=G-VVDP5JGEX8";
        document.head.appendChild(scriptGA);

        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        window.gtag = window.gtag || gtag;

        // Definir consentimento ANTES de iniciar a config
        if (isRefused) {
          gtag("consent", "default", {
            analytics_storage: "denied",
            ad_storage: "denied",
            ad_user_data: "denied",        // Novo par√¢metro v2
            ad_personalization: "denied",  // Novo par√¢metro v2
            wait_for_update: 500
          });
        } else {
          gtag("consent", "default", {
            analytics_storage: "granted",
            ad_storage: "granted",
            ad_user_data: "granted",
            ad_personalization: "granted",
            wait_for_update: 500
          });
        }

        gtag("js", new Date());

        // Configura√ß√£o dos IDs
        gtag("config", "G-VVDP5JGEX8"); // ‚ö° Atualizado para o ID do "Site Principal"
        gtag("config", "AW-952633102"); // Google Ads (Mantido)
      }

      /* -----------------------------------------------------
          2) FUN√á√ÉO INTERNA: carrega AdSense uma √∫nica vez
          ----------------------------------------------------- */
      function loadAdSenseOnce() {
        if (window.__adsenseLoaded) return;
        window.__adsenseLoaded = true;

        var scriptAd = document.createElement('script');
        scriptAd.async = true;
        scriptAd.src = "https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6472730056006847";
        scriptAd.crossOrigin = "anonymous";
        document.head.appendChild(scriptAd);

        console.log("üü¢ AdSense carregado (Modo Opt-out).");
      }

      // ‚ö° MUDAN√áA: Se n√£o estiver recusado, carrega AN√öNCIOS IMEDIATAMENTE
      if (!isRefused) {
        loadAdSenseOnce();
      }

      /* -----------------------------------------------------
          3) FUN√á√ÉO CENTRAL DE CONSENTIMENTO
          ----------------------------------------------------- */
      function applyConsent(consent) {
        if (typeof window.gtag === "function") {
          gtag("consent", "update", consent);
        }
        if (consent && consent.ad_storage === "granted") {
          loadAdSenseOnce();
        }
        try {
          localStorage.setItem("analytics_storage", consent.analytics_storage);
          localStorage.setItem("ad_storage", consent.ad_storage);
        } catch (e) { }
      }

      /* -----------------------------------------------------
          4) REAPLICA CONSENTIMENTO AO ENTRAR NA P√ÅGINA
          ----------------------------------------------------- */
      (function restoreConsent() {
        try {
          const saved = localStorage.getItem("cookieConsent");
          if (saved === "accepted") {
            applyConsent({ analytics_storage: "granted", ad_storage: "granted" });
          }
          if (saved === "refused") {
            applyConsent({ analytics_storage: "denied", ad_storage: "denied" });
          }
          if (saved === "managed") {
            applyConsent({
              analytics_storage: localStorage.getItem("analytics_storage") || "denied",
              ad_storage: localStorage.getItem("ad_storage") || "denied"
            });
          }
        } catch (e) { }
      })();

      /* -----------------------------------------------------
          5) API GLOBAL PARA O BANNER DE COOKIES
          ----------------------------------------------------- */
      window.acceptAllCookies = function () {
        localStorage.setItem("cookieConsent", "accepted");
        applyConsent({ analytics_storage: "granted", ad_storage: "granted" });
      };

      window.rejectAllCookies = function () {
        localStorage.setItem("cookieConsent", "refused");
        applyConsent({ analytics_storage: "denied", ad_storage: "denied" });
        // Remove visualmente
        var ads = document.querySelectorAll('ins.adsbygoogle, .google-auto-placed');
        ads.forEach(function (ad) { ad.style.display = 'none'; ad.innerHTML = ''; });
        console.log("üî¥ Consentimento revogado e an√∫ncios ocultados.");
      };

      window.applyGranularCookies = function (analyticsGranted, adsGranted) {
        localStorage.setItem("cookieConsent", "managed");
        applyConsent({
          analytics_storage: analyticsGranted ? "granted" : "denied",
          ad_storage: adsGranted ? "granted" : "denied"
        });
        if (!adsGranted) {
          var ads = document.querySelectorAll('ins.adsbygoogle, .google-auto-placed');
          ads.forEach(function (ad) { ad.style.display = 'none'; ad.innerHTML = ''; });
        }
      };
    }
  </script>
</body>
</html>